<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>员工请假</title>
		<link rel="icon" href="img/timg.jpg">
		<link rel="stylesheet" href="js/jquery-easyui-1.4.5/themes/icon.css" />
		<link rel="stylesheet" href="js/jquery-easyui-1.4.5/themes/default/easyui.css" />
		<script type="text/javascript" src="js/jquery-easyui-1.4.5/jquery.min.js"></script>
		<script type="text/javascript" src="js/jquery-easyui-1.4.5/jquery.easyui.min.js"></script>
		<script type="text/javascript" src="js/jquery-easyui-1.4.5/locale/easyui-lang-zh_CN.js"></script>
		<script type="text/jscript" src="js/jquery.edatagrid.js"></script>
		<script type="text/jscript" src="js/easyUIvalidate.js"></script>
		<style>
			.datagrid-td-rownumber {
				height: 26px;
			}
		</style>
		<script type="text/javascript">
			var token = window.localStorage.getItem("token"); //取出暂存的token数据
			var loginIds = window.localStorage.getItem("loginId"); // 登录用户的id
			var loginNames = window.localStorage.getItem("loginName"); // 登录用户的名称
			$(function() {
				$("#dg").edatagrid({ //为了加载小图标
					url: 'http://localhost:8080/SSMCyj/vacation/getVacation.php',
					queryParams: { //datagrid的固定参数
						token: token //必传
					},
					columns: [
						[{
								field: 'id',
								align: 'center',
								width: 280,
								title: '员工ID',
								hidden: true
							},
							{
								field: 'name',
								align: 'center',
								title: '员工名称',
								width: 80
							},
							{
								field: 'leaveType',
								align: 'center',
								title: '请假类型',
								width: 80
							},
							{
								field: 'leaveDate',
								align: 'center',
								title: '请假天数',
								width: 80
							},
							{
								field: 'isAgree',
								align: 'center',
								title: '审批状态',
								width: 80
							},
							{
								field: 'content',
								align: 'center',
								width: 300,
								title: '请假原因',
								formatter: formatterContent
							},
							{
								field: 'leaveTime',
								align: 'center',
								title: '请假时间',
								width: 180
							},
							{
								field: 'endTime',
								align: 'center',
								title: '结束时间',
								width: 180
							},
							{
								field: 'setPassword',
								width: 180,
								align: 'center',
								title: '操作',
								formatter: formatterOPUser
							},
						]
					],
					onLoadSuccess: function() {
						$(".easyui-linkbutton").linkbutton();
						handlePermission();
					}
				});
				/**
				 * 页面加载完成自动执行
				 * 使用权限控制元素的访问
				 */
				//handlePermission();

			});

			function handlePermission() {
				console.log('权限控制插件data-require-permission.js加载成功!');
				let permission = window.localStorage.getItem("permission"); //从session缓存中取出权限数组
				console.log("权限控制插件permission=>" + permission);
				$("*[data-require-permission]").map((i, ele) => {
					let elePer = $(ele).attr('data-require-permission');
					console.log("elePer=>" + elePer);

					let p = permission.split(",");

					let requireRemove = true;

					for(var i = 0; i < p.length; i++) {
						if(elePer == p[i]) requireRemove = false;
					}
					if(requireRemove) {
						$(ele).remove();
					};
				});
			}

			function formatterContent(value, row, index) {
				if(row.content != undefined) {
					return row.content.substr(0, 30) + "...";
				} else {
					return "暂无";
				}
			}

			//查询
			function doSearch() {
				$('#dg').datagrid('load', {
					token: token,
					name: $("#names").textbox('getValue'),
					leaveType: $("#leaveType").combobox('getValue')
				});
			}
		</script>

		<script type="text/javascript">
			//操作用户
			function formatterOPUser(value, row, index) {
				return "<a class='easyui-linkbutton' iconCls='icon-search' style='cursor: pointer;' onclick='showTail(" + index + ")'>查看</a> <a class='easyui-linkbutton' iconCls='icon-edit' style='cursor: pointer;' onclick='updVac(" +
					index + ")'>编辑</a>";
			}

			//表单序列化以后去掉表单中值为空的参数
			function serializeNotNull(serStr) {
				return serStr.split("&").filter(function(str) {
					return !str.endsWith("=")
				}).join("&");
			}

			function showTail(index) {
				var data = $("#dg").datagrid("getData"); //获取datagrid对应的json对象集合（再来一遍）。
				var row = data.rows[index]; //获取第index行对应的json对象（再来一遍）。

				$("#namess").html(row.name);
				$("#leaveTypes").html(row.leaveType);
				$("#leaveDates").html(row.leaveDate);
				$("#leaveTimes").html(row.leaveTime);
				$("#endTimes").html(row.endTime);
				$("#isAgrees").html(row.isAgree);
				$("#contents").html(row.content);
				$("#pName").html(row.pName);
				$("#pContents").html(row.pContent);

				$('#showStu').window('open');
			}

			function updVac(index) {
				var data = $("#dg").datagrid("getData"); //获取datagrid对应的json对象集合（再来一遍）。
				var row = data.rows[index]; //获取第index行对应的json对象（再来一遍）。

				if(row.isAgree == '准假') {
					$.messager.alert('内容信息', '该员工请假已通过,无法进行再次批注!', 'info');
					return;
				} else {
					$("#idss").val(row.id);
					$("#pNamess").val(loginNames);

					$("#updname").textbox('setValue', row.name);
					$("#updleaveType").combobox('setValue', row.leaveType);
					$("#updisAgree").combobox('setValue', row.isAgree);
					$("#updleaveTime").datetimebox('setValue', row.leaveTime);
					$("#updcontent").textbox('setValue', row.content);
					$("#updpContent").textbox('setValue', row.pContent);

					$("#updleaveDate").numberbox('setValue', row.leaveDate);
					$("#updendTime").datetimebox('setValue', row.endTime);

					$('#updStu').window('open');
				}
			}

			function updateStus() {
				var row = $('#dg').datagrid('getChecked');

				$.messager.confirm('确认', '您确认修改么？', function(r) {
					if(r) {
						var formData = serializeNotNull($('#editStuForm').serialize());
						var boo = $('#editStuForm').form('validate');
						if(boo) {
							$.ajax({
								type: "POST",
								url: "http://localhost:8080/SSMCyj/vacation/updVacation.php?token=" + token,
								cache: false,
								data: formData,
								dataType: "json",
								success: function(result) {
									$.messager.alert({
										title: '系统提示',
										msg: result.message,
										timeout: 3000, //推出时间
										showType: 'slide', //动画效果
										showSpeed: 3000
										//显示时间
									});
									$('#updStu').window('close');
									$('#dg').datagrid('reload');

								},
								error: function(result) {
									$.messager.alert({
										title: '系统提示',
										msg: result.message,
										timeout: 3000, //推出时间
										showType: 'slide', //动画效果
										showSpeed: 3000
										//显示时间
									});
									return;
								}
							});
						}

					}
				});
			}
		</script>

	</head>

	<body style="background: url(img/xingk2.jpg) no-repeat; background-size: 100% 710px">

		<table name="center" class="easyui-datagrid" id="dg" toolbar="#toolbar" title="请假列表" collapsible="true" style="width:100%; height:444px;overflow:auto" data-options="rownumbers:true,split:true,pagination:true,pageSize:10,singleSelect: true">

		</table>

		<div id="toolbar" style="padding:5px; height:auto;background: url(img/xingk1.jpg) no-repeat; background-size: 100% auto">
			<div id="tb" style="margin-bottom:5px">
				<from id="sousuo" method="post">
					员工名称: <input class="easyui-textbox" id="names" name="name" style="width:80px"> &nbsp;&nbsp;&nbsp; 请假类型:
					<select class="easyui-combobox" id="leaveType" name="leaveType" editable="false" panelHeight="auto">
						<option value="">全部类型</option>
						<option value="病假">病假</option>
						<option value="探亲">探亲</option>
						<option value="产假">产假</option>
						<option value="事假">事假</option>
						<option value="婚假">婚假</option>
						<option value="丧假">丧假</option>
						<option value="公假">公假</option>
						<option value="带薪">带薪</option>
					</select>
					&nbsp;&nbsp;&nbsp;
					<a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick="javascript:doSearch()">查询</a>
				</from>
			</div>
		</div>

		<!--
            	作者：867647213@qq.com
            	时间：2018-06-05
            	描述：查看请假信息
            -->

		<div class="panel window easyui-fluid">
			<div id="showStu" class="easyui-window" title="查看信息" data-options="iconCls:'icon-search',minimizable:false,closed:true,maximized:false" style="padding: 10px; width: auto; height: auto;">
				<table id="showStuTable" style="border-collapse:collapse;margin:10px auto;" border="1" bordercolor="#a0c6e5">
					<tbody>
						<tr>
							<td rowspan="5" style="width:20px;padding:7px;font-size:13px;background-color:aliceblue">在线查看</td>
							<td>姓名<span class="red">*</span></td>
							<td width="100px" id="namess"></td>
							<td>请假类型</td>
							<td width="100px" id="leaveTypes"></td>
							<td>请假天数</td>
							<td width="100px" id="leaveDates"></td>
						</tr>
						<tr>
							<td>请假时间</td>
							<td colspan="2" id="leaveTimes"></td>
							<td>结束时间</td>
							<td colspan="2" id="endTimes"></td>
						</tr>
						<tr>
							<td>批注人</td>
							<td width="100px" id="pName"></td>
							<td>审批状态</td>
							<td width="100px" colspan="3" id="isAgrees"></td>
						</tr>
						<tr>
							<td>请假原因</td>
							<td colspan="5" width="300px" height="40px" id="contents"></td>
						</tr>
						<tr>
							<td>批注信息</td>
							<td colspan="5" width="300px" height="40px" id="pContents"></td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<!--编辑请假信息-->
		<div id="updStu" class="easyui-window" title="批注请假" data-options="iconCls:'icon-edit',minimizable:false,closed:true,maximized:false" style="padding: 10px; width: auto; height: auto;">
			<form id="editStuForm">
				<input type="easyui-validatetimebox" name="id" id="idss" hidden="true" />
				<input type="easyui-validatetimebox" name="pName" id="pNamess" hidden="true" />
				<table id="showStuTable" style="border-collapse:collapse;margin:10px auto;" border="1" bordercolor="#a0c6e5">
					<tbody>
						<tbody>
							<tr>
								<td rowspan="4" style="width:20px;padding:7px;font-size:13px;background-color:aliceblue">在线查看</td>
								<td>姓名<span class="red">*</span></td>
								<td width="100px">
									<input id="updname" name="name" readonly="true" class="easyui-textbox" data-options="required:true"></td>
								</td>
								<td>请假类型</td>
								<td width="100px">
									<select class="easyui-combobox" id="updleaveType" readonly="true" name="leaveType" editable="false" panelHeight="auto" style="width: 98%;">
										<option value="未知">未知</option>
										<option value="病假">病假</option>
										<option value="探亲">探亲</option>
										<option value="产假">产假</option>
										<option value="事假">事假</option>
										<option value="婚假">婚假</option>
										<option value="丧假">丧假</option>
										<option value="公假">公假</option>
										<option value="带薪">带薪</option>
									</select>
								</td>
								<td>请假天数</td>
								<td width="100px">
									<input class="easyui-numberbox" readonly="true" id="updleaveDate" name="leaveDate" data-options="required:true,validType:'intPlus'">
								</td>
							</tr>
							<tr>
								<td>请假时间</td>
								<td>
									<input name="leaveTime" style="display: none; " readonly="true" id="updleaveTime" class="easyui-datetimebox">
								</td>
								<td>结束时间</td>
								<td>
									<input name="endTime" style="display: none; " readonly="true" id="updendTime" class="easyui-datetimebox">
								</td>
								<td>审批状态</td>
								<td width="100px">
									<select class="easyui-combobox" id="updisAgree" name="isAgree" editable="false" panelHeight="auto" style="width: 98%;">
										<option value="未知">未知</option>
										<option value="审核中">审核中</option>
										<option value="不准许">不准许</option>
										<option value="准假">准假</option>
									</select>
								</td>
							</tr>
							<tr>
								<td>请假原因</td>
								<td colspan="5" width="300px">
									<input name="content" id="updcontent" readonly="true" class="easyui-textbox" maxlength="140" data-options="multiline:true" style="border: medium none; width: 97%; height: 40px; resize: none; display: none;">
								</td>
							</tr>
							<tr>
								<td>批注信息</td>
								<td colspan="5" width="300px">
									<input name="pContent" id="updpContent" class="easyui-textbox" maxlength="140" data-options="multiline:true" style="border: medium none; width: 97%; height: 40px; resize: none; display: none;">
								</td>
							</tr>
							<tr>
								<td colspan="7" align="center">
									<a id="" group="" href="#" class="easyui-linkbutton" iconcls="icon-save" onclick="updateStus()">
										保存
									</a>
									<a id="" group="" href="#" class="easyui-linkbutton" iconcls="icon-cancel" onclick="javascript:$('#updStu').window('close')">
										取消
									</a>
								</td>
							</tr>
						</tbody>
				</table>
			</form>
		</div>
	</body>

</html>