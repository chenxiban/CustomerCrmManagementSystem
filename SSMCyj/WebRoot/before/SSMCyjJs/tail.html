<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>网络跟踪</title>
		<link rel="icon" href="img/timg.jpg">
		<link rel="stylesheet" href="js/jquery-easyui-1.4.5/themes/icon.css" />
		<link rel="stylesheet" href="js/jquery-easyui-1.4.5/themes/default/easyui.css" />
		<script type="text/javascript" src="js/jquery-easyui-1.4.5/jquery.min.js"></script>
		<script type="text/javascript" src="js/jquery-easyui-1.4.5/jquery.easyui.min.js"></script>
		<script type="text/javascript" src="js/jquery-easyui-1.4.5/locale/easyui-lang-zh_CN.js"></script>
		<script type="text/jscript" src="js/jquery.edatagrid.js"></script>
		<script type="text/jscript" src="js/easyUIvalidate.js"></script>
		<style>
			.datagrid-td-rownumber {
				height: 26px;
			}
		</style>
		<script type="text/javascript">
			var token = window.localStorage.getItem("token"); //取出暂存的token数据
			var loginIds = window.localStorage.getItem("loginId"); // 登录用户的id
			var roleId = window.localStorage.getItem("roleIds"); // 登录用户拥有的角色
			let p;

			$(function() {
				p = roleId.split(",");
				for(var i = 0; i < p.length; i++) {
					if(p[i] == 2 || p[i] == 15) {
						$("#dg").edatagrid({ //为了加载小图标
							url: 'http://localhost:8080/SSMCyj/netfloows/getNetfloows.php',
							queryParams: { //datagrid的固定参数
								token: token, //必传
								userId: 0
							},
							columns: [
								[{
										field: 'id',
										align: 'center',
										width: 280,
										title: 'ID',
										hidden: true
									},
									{
										field: 'studentId',
										align: 'center',
										title: '学生ID',
										width: 280,
										hidden: true
									},
									{
										field: 'studentName',
										align: 'center',
										title: '学生姓名',
										width: 100
									},
									{
										field: 'followState',
										align: 'center',
										title: '跟踪状态',
										width: 100
									},
									{
										field: 'followType',
										align: 'center',
										title: '跟踪方式',
										width: 100
									},
									{
										field: 'setContent',
										align: 'center',
										width: 550,
										title: '备注',
										formatter: formatterContent
									},
									{
										field: 'nextFollowTime',
										align: 'center',
										title: '下次跟踪时间',
										width: 140
									},
									{
										field: 'setPassword',
										width: 180,
										align: 'center',
										title: '操作',
										formatter: formatterOPUser
									},
								]
							],
							onLoadSuccess: function() {
								$(".easyui-linkbutton").linkbutton();
							}
						});

					} else {
						$("#dg").edatagrid({ //为了加载小图标
							url: 'http://localhost:8080/SSMCyj/netfloows/getNetfloows.php',
							queryParams: { //datagrid的固定参数
								token: token, //必传
								userId: loginIds
							},
							columns: [
								[{
										field: 'id',
										align: 'center',
										width: 280,
										title: 'ID',
										hidden: true
									},
									{
										field: 'studentId',
										align: 'center',
										title: '学生ID',
										width: 280,
										hidden: true
									},
									{
										field: 'studentName',
										align: 'center',
										title: '学生姓名',
										width: 100
									},
									{
										field: 'followState',
										align: 'center',
										title: '跟踪状态',
										width: 100
									},
									{
										field: 'followType',
										align: 'center',
										title: '跟踪方式',
										width: 100
									},
									{
										field: 'setContent',
										align: 'center',
										width: 550,
										title: '备注',
										formatter: formatterContent
									},
									{
										field: 'nextFollowTime',
										align: 'center',
										title: '下次跟踪时间',
										width: 140
									},
									{
										field: 'setPassword',
										width: 180,
										align: 'center',
										title: '操作',
										formatter: formatterOPUser
									},
								]
							],
							onLoadSuccess: function() {
								$(".easyui-linkbutton").linkbutton();
							}
						});
					}
				}

			});

			//查询
			function doSearch() {
				var birthStart = $('#s_bbirthday').datebox('getValue');
				var birthEnd = $('#s_ebirthday').datebox('getValue');
				var boo = $('#sousuo').form('validate');
				if(boo) {
					$('#dg').datagrid('load', {
						token: token,
						userId: 0,
						studentName: $("#studentName").val(),
						birthStart: birthStart,
						birthEnd: birthEnd,
						followState: $("#followState").combobox('getValue'),
						followType: $("#followType").combobox('getValue')
					});
				}
			}
		</script>

		<!--出现操作的字样 -->
		<script>
			function formatterContent(value, row, index) {
				if(row.content.length > 0) {
					return row.content.substr(0, 30) + "...";
				} else {
					return "暂无";
				}
			}

			//操作用户
			function formatterOPUser(value, row, index) {
				return "<a class='easyui-linkbutton' iconCls='icon-search' style='cursor: pointer;' onclick='showTail(" + index + ")'>查看</a> <a class='easyui-linkbutton' data-require-permission='netfloows:addNetFollows.php' iconCls='icon-add' style='cursor: pointer;' onclick='addStudents(" +
					index + ")'>跟踪</a>";
			}

			function showTail(index) {
				var data = $("#dg").datagrid("getData"); //获取datagrid对应的json对象集合（再来一遍）。
				var row = data.rows[index]; //获取第index行对应的json对象（再来一遍）。

				$.messager.alert('内容信息', row.content, 'info');
			}

			function addStudents(index) {
				var data = $("#dg").datagrid("getData"); //获取datagrid对应的json对象集合（再来一遍）。
				var row = data.rows[index]; //获取第index行对应的json对象（再来一遍）。
				$("#f_stuId").val(row.studentId);
				$("#f_stuName").val(row.studentName);
				$("#f_userId").val(loginIds);

				$("#addFollow").window({
					modal: true
				});

				$("#addFollow").window('open');
			}

			function saveNetFollow() {
				$.messager.confirm('确认', '您确认添加么？', function(r) {
					if(r) {
						var formData = $('#addFollowForm').serialize();
						var boo = $('#addFollowForm').form('validate');
						if(boo) {
							$.ajax({
								type: "POST",
								url: "http://localhost:8080/SSMCyj/netfloows/addNetFollows.php?token=" + token,
								cache: false,
								data: formData,
								dataType: "json",
								success: function(result) {
									$.messager.alert({
										title: '系统提示',
										msg: result.message,
										timeout: 3000, //推出时间
										showType: 'slide', //动画效果
										showSpeed: 3000
										//显示时间
									});
									$("#addFollowForm").form('clear');
									$("#addFollow").window('close');
									$('#dg').datagrid('reload');
								},
								error: function(result) {
									$.messager.alert({
										title: '系统提示',
										msg: result.message,
										timeout: 3000, //推出时间
										showType: 'slide', //动画效果
										showSpeed: 3000
										//显示时间
									});
									return;
								}
							});
						}

					}
				});
			}
		</script>

	</head>

	<body style="background: url(img/xingk2.jpg) no-repeat; background-size: 100% 710px">

		<table name="center" class="easyui-datagrid" id="dg" toolbar="#toolbar" title="网络跟踪" collapsible="true" style="width:100%; height:444px;overflow:auto" data-options="fitColumns:false,rownumbers:true,split:true,pagination:true,pageSize:10,singleSelect: true">
			<thead>
				<tr>
					<th data-options="field:'id',align:'center',width:280,hidden:true">ID</th>
					<th data-options="field:'studentId',align:'center',width:280,hidden:true">学生ID</th>
					<th data-options="field:'studentName',align:'center',width:100">学生名称</th>
					<th data-options="field:'followState',align:'center',width:100">回访情况</th>
					<th data-options="field:'followType',align:'center',width:100">跟踪方式</th>
					<th data-options="field:'setContent',align:'center',width:550,formatter:formatterContent">内容</th>
					<th data-options="field:'nextFollowTime',align:'center',width:140">下次跟踪时间</th>
					<th data-options="field:'setPassword',width:180,align:'center',formatter:formatterOPUser">操作</th>
				</tr>
			</thead>
		</table>

		<div id="toolbar" style="padding:5px; height:auto;background: url(img/xingk1.jpg) no-repeat; background-size: 100% auto">
			<div id="tb" style="margin-bottom:5px">
				<from id="sousuo" method="post">
					学生名称: <input class="easyui-textbox" id="studentName" name="studentName" style="width:80px"> &nbsp;&nbsp;&nbsp; 起止时间: <input type="text" class="easyui-datebox" name="s_bbirthday" id="s_bbirthday" size="11" editable="false" /> ~
					<input type="text" class="easyui-datebox" name="s_ebirthday" data-options="validType:'equaldDate[\'#s_bbirthday\']'" id="s_ebirthday" size="11" editable="false" /> &nbsp;&nbsp;&nbsp; 回访情况:
					<select class="easyui-combobox" id="followState" name="followState" editable="false" panelHeight="auto">
						<option value="">--请选择--</option>
						<option value="上门未报名">上门未报名</option>
						<option value="报名未进班">报名未进班</option>
						<option value="考虑中">考虑中</option>
						<option value="未上门">未上门</option>
						<option value="已进班">已进班</option>
						<option value="已结业">已结业</option>
						<option value="已就业">已就业</option>
					</select> &nbsp;&nbsp;&nbsp; 跟踪方式:
					<select class="easyui-combobox" id="followType" name="followType" editable="false" panelHeight="auto">
						<option value="">--请选择--</option>
						<option value="面谈">面谈</option>
						<option value="电话">电话</option>
						<option value="网络">网络</option>
						<option value="宣讲">宣讲</option>
					</select>
					<a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick="javascript:doSearch()">查询</a>
				</from>
			</div>
		</div>

		<div id="dlg" class="easyui-dialog" style="width:350px;height:200px;padding:10px 20px" closed="true">

		</div>

		<!-- 添加跟踪 -->
		<div id="addFollow" class="easyui-window" title="新建跟踪" data-options="iconCls:'icon-add',minimizable:false,closed:true," style="width:50%;padding:10px;">
			<form id="addFollowForm">
				<table border="1" bordercolor="#a0c6e5" style="border-collapse:collapse;margin:10px auto;">
					<tr>
						<input id="f_stuId" name="studentId" type="hidden" />
						<input id="f_stuName" name="studentName" type="hidden" />
						<input id="f_userId" name="userId" type="hidden" />
						<td>回访时间:</td>
						<td><input class="easyui-datetimebox" required="true" id="followTime" name="followTime"></td>
						<td>回访情况:</td>
						<td><input id="followState" name="followState" class="easyui-combobox" data-options="editable:false,valueField:'id',textField:'text',panelHeight:'auto',
                          data:[{'id':'考虑中','text':'考虑中','selected':true},
                                {'id':'未上门','text':'未上门'},
                                {'id':'上门未报名','text':'上门未报名'},
                                {'id':'报名未进班','text':'报名未进班'},
                                {'id':'已进班','text':'已进班'},
                                {'id':'已结业','text':'已结业'},
                                {'id':'已就业','text':'已就业'}]" /></td>
					</tr>
					<tr>
						<td>跟踪方式:</td>
						<td><input id="followType" name="followType" class="easyui-combobox" data-options="editable:false,valueField:'id',textField:'text',panelHeight:'auto',
                        data:[{'id':'电话','text':'电话','selected':true},
                              {'id':'网络','text':'网络'},
                              {'id':'面谈','text':'面谈'},
                              {'id':'宣讲','text':'宣讲'}]" /></td>
						<td>下次跟踪时间:</td>
						<td><input class="easyui-datetimebox" required="true" id="nextFollowTime" data-options="validType:'nextDate[\'#followTime\']'" name="nextFollowTime"></td>
					</tr>
					<tr>
						<td>备注:</td>
						<td colspan="3">
							<input id="content" name="content" class="easyui-textbox" data-options="multiline:true" style="border:none;width:97%;resize:none;font-size:13px" />
						</td>
					</tr>
					<tr>
						<td colspan="4" align="center">
							<a href="#" class="easyui-linkbutton" iconCls="icon-save" onclick="saveNetFollow()">保存</a>
							<a href="#" class="easyui-linkbutton" iconCls="icon-cancel" onclick="$('#addFollow').window('close')">取消</a>
						</td>
					</tr>
				</table>
			</form>
		</div>

	</body>

</html>